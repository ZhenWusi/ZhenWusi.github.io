<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- 基本 meta 标签 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- SEO meta 标签 -->
  <title>RLHF 的三阶段流程 | 九九的个人博客 | JiuJiu&#39;s Blog</title>
  <meta name="description" content="一个热爱技术的开发者的个人博客，分享编程、技术和生活感悟。">
  <meta name="keywords" content="LLM">
  <meta name="author" content="ZhenWusi">

  <!-- Open Graph 社交分享 -->
  <meta property="og:title" content="RLHF 的三阶段流程">
  <meta property="og:description" content="一个热爱技术的开发者的个人博客，分享编程、技术和生活感悟。">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/index.html">
  <meta property="og:image" content="/img/%E5%A4%B4%E5%83%8F.jpg">
  <meta property="og:image:alt" content="ZhenWusi的头像">

  <!-- 图标 -->
  <link rel="icon" href="/img/头像.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="/img/头像.jpg">
  <link rel="shortcut icon" href="/img/头像.jpg">

  <!-- Google Fonts - Noto Sans SC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

  <!-- Font Awesome 图标 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script defer src="https://code.iconify.design/iconify-icon/1.0.8/iconify-icon.min.js"></script>

  <!-- 主样式表 -->
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="九九的个人博客 | JiuJiu's Blog" type="application/atom+xml">
</head>
<body>
  <!-- 全局加载动画 -->
  <div id="loading-mask">
    <div class="spinner"></div>
  </div>

  <!-- 顶部导航栏 -->
  

<!-- 顶部导航栏 -->
<header class="site-header" id="site-header">
  <div class="header-inner">
    <!-- 桌面端导航菜单 -->
    <nav class="site-nav" id="site-nav">
      
        <a href="/" class="nav-link">
          
            <iconify-icon icon="mingcute:home-2-fill"></iconify-icon>
          
          <span class="nav-text">首页</span>
        </a>
      
        <a href="/archives" class="nav-link">
          
            <iconify-icon icon="mingcute:inbox-fill"></iconify-icon>
          
          <span class="nav-text">文章</span>
        </a>
      
        <a href="/about" class="nav-link">
          
            <iconify-icon icon="mingcute:user-info-fill"></iconify-icon>
          
          <span class="nav-text">关于</span>
        </a>
      
        <a href="/categories" class="nav-link">
          
            <iconify-icon icon="mingcute:classify-2-fill"></iconify-icon>
          
          <span class="nav-text">分类</span>
        </a>
      
        <a href="/tags" class="nav-link">
          
            <iconify-icon icon="mingcute:tag-fill"></iconify-icon>
          
          <span class="nav-text">标签</span>
        </a>
      
    </nav>

    <!-- 功能按钮区域 -->
    <div class="header-actions">
      <!-- 搜索按钮 -->
      <button class="action-btn" id="search-toggle" title="搜索">
        <i class="fas fa-search"></i>
      </button>
      <!-- 移动端菜单按钮 -->
      <button class="action-btn mobile-menu-btn" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </div>

  <!-- 搜索弹窗 -->
  <div class="search-overlay" id="search-overlay">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="搜索文章..." autocomplete="off">
      <button id="search-close"><i class="fas fa-times"></i></button>
    </div>
    <div class="search-results" id="search-results"></div>
  </div>
</header>

<!-- 移动端侧滑菜单 -->
<div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
<aside class="mobile-menu" id="mobile-menu">
  <div class="mobile-menu-header">
    
      <img src="/img/头像.jpg" alt="头像" class="mobile-avatar">
    
    <h3>ZhenWusi</h3>
    
      <p>龙出海，虎下山…… | Exploring code &amp; AI</p>
    
  </div>
  <nav class="mobile-nav">
    
      <a href="/" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:home-2-fill"></iconify-icon>
        
        <span class="nav-text">首页</span>
      </a>
    
      <a href="/archives" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:inbox-fill"></iconify-icon>
        
        <span class="nav-text">文章</span>
      </a>
    
      <a href="/about" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:user-info-fill"></iconify-icon>
        
        <span class="nav-text">关于</span>
      </a>
    
      <a href="/categories" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:classify-2-fill"></iconify-icon>
        
        <span class="nav-text">分类</span>
      </a>
    
      <a href="/tags" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:tag-fill"></iconify-icon>
        
        <span class="nav-text">标签</span>
      </a>
    
  </nav>
</aside>


  <!-- 页面主内容 -->
  <main class="main-content">
    <!-- 文章详情页布局 -->



<!-- 文章顶部横幅 -->
<section class="post-banner" style="background-image: url('/img/background/')">
  <div class="hero-overlay"></div>
  <div class="post-banner-content">
    <!-- 分类 -->
    
      <div class="post-banner-cats">
        
          <a href="/categories/%E7%AE%97%E6%B3%95/"><i class="fas fa-folder"></i> 算法</a>
        
      </div>
    
    <h1 class="post-banner-title">RLHF 的三阶段流程</h1>
    <div class="post-banner-meta">
      <span><i class="far fa-calendar-alt"></i> 2026-02-23</span>
      <span><i class="far fa-clock"></i> 阅读约 1.4k 字</span>
      
        <span><i class="fas fa-tags"></i>
          
          LLM
        </span>
      
    </div>
  </div>
</section>

<!-- 文章主体 -->
<div class="reading-progress"><span class="reading-progress__bar"></span></div>
<div class="container post-container">
  <div class="post-layout">
    <!-- 文章内容区域 -->
    <article class="post-content-wrap">
      <!-- 目录（TOC） -->
      

      <!-- 正文 -->
      <div class="post-body markdown-body" id="post-body">
        <script type="math/tex; mode=display">
\begin{aligned}
&\textbf{阶段概览} \\
&\text{RLHF（Reinforcement Learning from Human Feedback）包含三大流程：} \\
&\text{监督微调（SFT）} \rightarrow \text{偏好采样与奖励建模} \rightarrow \text{强化学习优化（RL）。} \\
&\text{直观理解：先学“怎么说话”，再学“什么话更好”，最后推动模型输出更优回答。}
\end{aligned}</script><script type="math/tex; mode=display">
\begin{aligned}
&\textbf{阶段一：监督微调（SFT）} \\
&\text{起点是对一个预训练语言模型执行监督微调，以人工高质量数据构建 } \pi_{SFT}。 \\
&\text{数据形式：}(x, y) \text{，其中 } x \text{ 为 prompt，} y \text{ 为人工答案。} \\
&\text{目标：掌握基本对话与任务能力，即“怎么说话”。}
\end{aligned}</script><script type="math/tex; mode=display">\max_{\theta} \sum_{(x,y) \in D} \log \pi_\theta(y|x)</script><script type="math/tex; mode=display">
\begin{aligned}
&\textbf{阶段二：奖励模型（Reward Modeling）} \\
&\text{用 } \pi_{SFT} \text{ 对同一 prompt } x \text{ 采样两个回答 } y_1, y_2。 \\
&\text{人类标注给出偏好： } y_w \succ y_l \mid x。 \\
&y_w: \text{赢家（preferred）}, \quad y_l: \text{输家（rejected）。} \\
&\text{假设存在潜在真实奖励 } r^*(x,y)，\text{偏好来自该奖励差异。}
\end{aligned}</script><script type="math/tex; mode=display">y_1, y_2 \sim \pi_{SFT}(y|x)</script><script type="math/tex; mode=display">y_w \succ y_l \mid x</script><script type="math/tex; mode=display">p^*(y_1 > y_2 | x) = \frac{\exp(r^*(x, y_1))}{\exp(r^*(x, y_1)) + \exp(r^*(x, y_2))} \tag{1}</script><script type="math/tex; mode=display">D = \{(x^{(i)}, y_w^{(i)}, y_l^{(i)})\}_{i=1}^N</script><script type="math/tex; mode=display">\mathcal{L}_\text{R}(r_\phi, \mathcal{D}) = -\mathbb{E}_{(x, y_w, y_l) \sim \mathcal{D}} \left[ \log \sigma (r_\phi(x, y_w) - r_\phi(x, y_l)) \right] \tag{2}</script><script type="math/tex; mode=display">
\begin{aligned}
&\textbf{Bradley-Terry（BT）模型说明} \\
&\text{每个对象 } i \text{ 具有潜在实力 } \lambda_i。 \\
&\text{比较 } i \text{ 与 } j \text{ 时，战胜概率：}
\end{aligned}</script><script type="math/tex; mode=display">P(i \succ j) = \frac{\lambda_i}{\lambda_i + \lambda_j}</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{在 RLHF 场景中：} r(x,y) \text{ 视作实力值，偏好数据即比较结果。} \\
&\text{用概率模型刻画人类噪声，而非硬性“分数更大者必胜”。}
\end{aligned}</script><script type="math/tex; mode=display">y_1 \succ y_2 \iff r^*(x,y_1) > r^*(x,y_2)</script><script type="math/tex; mode=display">p^*(y_1 \succ y_2 \mid x) = \frac{1}{1 + e^{-(r^*(x,y_1) - r^*(x,y_2))}}</script><script type="math/tex; mode=display">\sigma(z) = \frac{1}{1 + e^{-z}}</script><script type="math/tex; mode=display">p^*(y_1 \succ y_2 \mid x) = \sigma(r^*(x,y_1) - r^*(x,y_2))</script><script type="math/tex; mode=display">\log p_\theta(y_w \succ y_l \mid x) = \log \sigma(r_\theta(x,y_w) - r_\theta(x,y_l))</script><script type="math/tex; mode=display">\max_\theta \sum_{i=1}^N \log \sigma(r_\theta(x^{(i)}, y_w^{(i)}) - r_\theta(x^{(i)}, y_l^{(i)}))</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{对数把连乘变为连加，不改变最优解（单调递增）。} \\
&\text{因此常等价为最小化负对数似然：}
\end{aligned}</script><script type="math/tex; mode=display">L_R = -\mathbb{E}_{(x,y_w,y_l) \sim D} [\log \sigma(r_\theta(x,y_w) - r_\theta(x,y_l))]</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{有限数据集 } D = \{z_1,\ldots,z_N\} \text{ 上，期望等于平均值：}
\end{aligned}</script><script type="math/tex; mode=display">\mathbb{E}_{z \sim D} [f(z)] = \frac{1}{N} \sum_{i=1}^N f(z_i)</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{设 } f(x,y_w,y_l) = \log \sigma(r_\theta(x,y_w) - r_\theta(x,y_l))，\text{则：}
\end{aligned}</script><script type="math/tex; mode=display">
\mathbb{E}_{(x,y_w,y_l) \sim D} [f] = \frac{1}{N} \sum_{i=1}^N \log \sigma(r_\theta(x^{(i)}, y_w^{(i)}) - r_\theta(x^{(i)}, y_l^{(i)}))</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{乘以正的常数不改变最优解：}
\end{aligned}</script><script type="math/tex; mode=display">\arg\max_\theta \sum_{i=1}^N f_i = \arg\max_\theta \frac{1}{N} \sum_{i=1}^N f_i</script><script type="math/tex; mode=display">
\begin{aligned}
&\max_\theta \mathbb{E}_D[\log \sigma(\cdots)] = \min_\theta -\mathbb{E}_D[\log \sigma(\cdots)] \\
&\text{因此记作 } L_R = -\mathbb{E}_D[\log \sigma(\cdots)]，\text{配合梯度下降习惯“最小化损失”。}
\end{aligned}</script><script type="math/tex; mode=display">
\begin{aligned}
&\textbf{阶段三：RL 微调} \\
&\text{策略在奖励模型指导下继续优化，同时受 KL 约束保持与 } \pi_{SFT} \text{ 接近。}
\end{aligned}</script><script type="math/tex; mode=display">\max_{\pi_\theta} \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi_\theta(y|x)} \left[ r_\phi(x, y) - \beta D_{\text{KL}} \left[ \pi_\theta(y|x) \middle\| \pi_{\text{ref}}(y|x) \right] \right] \tag{3}</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{初始条件：} \pi_\theta = \pi_{ref} = \pi_{SFT}。 \\
&\text{目标：保持与参考策略接近的同时最大化奖励。} \\
&\text{KL 惩罚确保模型不过度偏离原始能力。}
\end{aligned}</script><script type="math/tex; mode=display">D_{\text{KL}}[P \| Q] = \sum_x P(x) \log \frac{P(x)}{Q(x)}</script><script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta(y|x) \| \pi_{SFT}(y|x)] = \mathbb{E}_{y \sim \pi_\theta} \left[ \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)} \right]</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{若 } \pi_\theta = \pi_{SFT} \Rightarrow KL = 0；\text{偏离越大，KL 越大，故需惩罚。}
\end{aligned}</script><script type="math/tex; mode=display">D_{\text{KL}}[P \| Q] = \sum_i P(i) \log \frac{P(i)}{Q(i)}</script><script type="math/tex; mode=display">\mathbb{E}_{Y \sim P}[f(Y)] = \sum_{y \in \mathcal{Y}} P(y) f(y)</script><script type="math/tex; mode=display">
\begin{aligned}
&P = \pi_\theta(y|x), \quad Q = \pi_{SFT}(y|x), \quad \mathcal{Y} = \text{所有可能回答序列}。 \\
&\text{代入得：}
\end{aligned}</script><script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta \| \pi_{SFT}] = \sum_y \pi_\theta(y|x) \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)}</script><script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta \| \pi_{SFT}] = \mathbb{E}_{y \sim \pi_\theta(y|x)} \left[ \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)} \right]</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{写成期望的原因：} \\
&1. \text{语言模型输出空间巨大，无法直接求和。} \\
&2. \text{期望形式便于用蒙特卡洛采样近似。} \\
&3. \text{与原目标 } \mathbb{E}_{y \sim \pi_\theta}[r(x,y)] \text{ 形式一致，便于合并。}
\end{aligned}</script><script type="math/tex; mode=display">\max_{\pi_\theta} \mathbb{E}_{y \sim \pi_\theta} \left[ r(x,y) - \beta \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)} \right]</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{离散生成导致目标不可直接对 } \theta \text{ 求导；需借助策略梯度（REINFORCE/PPO）。}
\end{aligned}</script><script type="math/tex; mode=display">D_{\text{KL}}(\pi_\theta \| \pi_{ref}) = \mathbb{E}_{y \sim \pi_\theta} \left[ \log \pi_\theta(y|x) - \log \pi_{ref}(y|x) \right]</script><script type="math/tex; mode=display">\mathbb{E}_{y \sim \pi_\theta} \left[ r_\phi(x, y) - \beta \left( \log \pi_\theta(y|x) - \log \pi_{ref}(y|x) \right) \right]</script><script type="math/tex; mode=display">r(x, y) = r_\phi(x, y) - \beta \left( \log \pi_\theta(y|x) - \log \pi_{ref}(y|x) \right)</script><script type="math/tex; mode=display">r(x, y) = r_\phi(x, y) - \left( \log \pi_\theta(y|x) - \log \pi_{ref}(y|x) \right)</script><script type="math/tex; mode=display">\max_{\pi_\theta} \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi_\theta(y|x)} \left[ r(x, y) \right]</script><script type="math/tex; mode=display">
\begin{aligned}
&\text{上式中的 } r(x,y) \text{ 已包含 KL 惩罚，因此目标转化为无约束奖励最大化。}
\end{aligned}</script><script type="math/tex; mode=display">
\begin{aligned}
&\textbf{直接偏好优化（DPO）提要} \\
&\text{DPO 直接对偏好数据开展优化，省略显式奖励模型，} \\
&\text{其核心同样可被写成纯粹的 LaTeX 目标函数与对偶形式。}
\end{aligned}</script>
      </div>

      <!-- 版权声明 -->
      
        <div class="post-copyright">
          <p><strong><i class="fas fa-copyright"></i> 版权声明</strong></p>
          <p>本文作者：ZhenWusi</p>
          <p>本文链接：<a href="https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/">https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/</a></p>
          <p>除特别声明外，本站所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p>
        </div>
      

      <!-- 文章标签 -->
      
        <div class="post-tags">
          
            <a href="/tags/LLM/" class="tag-item">
              <i class="fas fa-hashtag"></i>LLM
            </a>
          
        </div>
      

      <!-- 上一篇 / 下一篇导航 -->
      <nav class="post-nav">
        
          <span class="post-nav-item prev disabled"></span>
        
        
          <a href="/2026/02/23/%E5%8A%9B%E6%89%A3/" class="post-nav-item next">
            <span class="post-nav-label">下一篇 <i class="fas fa-chevron-right"></i></span>
            <span class="post-nav-title">力扣 88：合并两个有序数组</span>
          </a>
        
      </nav>

      <!-- 评论区 -->
      <!-- 评论系统组件 -->


    </article>

    <!-- 侧边栏目录（桌面端） -->
    
  </div>
</div>

  </main>

  <!-- 页脚 -->
  <!-- 页脚区域 -->
<footer class="site-footer">
  <div class="footer-inner">
    <!-- 页脚信息 -->
    <div class="footer-info">
      <p>
        &copy; 2025 - 2026
        <a href="/">ZhenWusi</a>
      </p>
      <p class="footer-powered">
        
          由 <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 驱动 |
          主题 <a href="/">NINE</a>
        
      </p>
      
    </div>

    <!-- 页脚社交链接 -->
    <div class="footer-social">
      
      
        
        <a href="https://github.com/ZhenWusi" target="_blank" rel="noopener" title="Github">
          
            <iconify-icon icon="mingcute:github-fill"></iconify-icon>
          
        </a>
      
        
        <a href="https://www.zhihu.com" target="_blank" rel="noopener" title="ZhiHu">
          
            <iconify-icon icon="ri:zhihu-line"></iconify-icon>
          
        </a>
      
        
        <a href="https://twitter.com" target="_blank" rel="noopener" title="Twitter">
          
            <iconify-icon icon="mingcute:social-x-fill"></iconify-icon>
          
        </a>
      
      <a href="/atom.xml" target="_blank" title="RSS 订阅">
        <i class="fas fa-rss"></i>
      </a>
    </div>
  </div>
</footer>


  <!-- 回到顶部按钮 -->
  <button id="back-to-top" title="回到顶部">
    <i class="fas fa-chevron-up"></i>
  </button>

  <!-- 音乐播放器 -->
  
    <!-- 左下角音乐播放器 -->

<div class="mini-music-player" id="mini-music-player">
  <!-- 音乐按钮 -->
  <button class="music-toggle-btn" id="music-toggle-btn" title="音乐播放器">
    <i class="fas fa-music"></i>
  </button>

  <!-- 播放器面板 -->
  <div class="music-panel" id="music-panel">
    <div class="music-content">
      <!-- 自定义播放器 -->
      <div class="custom-player">
        <div class="player-header">
          <div class="song-info">
            <div class="song-title" id="song-title">加载中...</div>
            <div class="song-artist" id="song-artist">请稍候</div>
          </div>
          <div class="player-controls">
            <button class="control-btn" id="prev-btn" title="上一首">
              <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-btn play-btn" id="play-btn" title="播放/暂停">
              <i class="fas fa-play"></i>
            </button>
            <button class="control-btn" id="next-btn" title="下一首">
              <i class="fas fa-step-forward"></i>
            </button>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-time" id="current-time">0:00</div>
          <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-time" id="total-time">0:00</div>
        </div>
        
        <div class="playlist-container">
          <div class="playlist-header">
            <span>歌单列表</span>
            <span class="song-count" id="song-count">0首</span>
          </div>
          <div class="playlist-list" id="playlist-list">
            <!-- 歌曲列表将在这里动态生成 -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 音乐播放器控制
  const musicToggleBtn = document.getElementById('music-toggle-btn');
  const musicPanel = document.getElementById('music-panel');
  const playBtn = document.getElementById('play-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const songTitle = document.getElementById('song-title');
  const songArtist = document.getElementById('song-artist');
  const currentTime = document.getElementById('current-time');
  const totalTime = document.getElementById('total-time');
  const progressFill = document.getElementById('progress-fill');
  const playlistList = document.getElementById('playlist-list');
  const songCount = document.getElementById('song-count');
  
  let songs = [];
  let currentSongIndex = 0;
  let isPlaying = false;
  let audioElement = null;
  
  // 音乐播放器状态管理
  const MUSIC_PLAYER_STATE_KEY = 'musicPlayerState';
  
  // 保存播放器状态
  function savePlayerState() {
    const state = {
      currentSongIndex: currentSongIndex,
      isPlaying: isPlaying,
      currentTime: audioElement ? audioElement.currentTime : 0,
      panelVisible: musicPanel ? musicPanel.classList.contains('active') : false
    };
    localStorage.setItem(MUSIC_PLAYER_STATE_KEY, JSON.stringify(state));
    console.log('保存播放器状态:', state);
  }
  
  // 恢复播放器状态
  function restorePlayerState() {
    try {
      const savedState = localStorage.getItem(MUSIC_PLAYER_STATE_KEY);
      if (savedState) {
        const state = JSON.parse(savedState);
        console.log('恢复播放器状态:', state);
        
        // 恢复歌曲索引
        if (state.currentSongIndex !== undefined) {
          currentSongIndex = state.currentSongIndex;
        }
        
        // 恢复播放状态
        if (state.isPlaying !== undefined) {
          isPlaying = state.isPlaying;
        }
        
        // 恢复面板显示状态
        if (state.panelVisible && musicPanel) {
          musicPanel.classList.add('active');
        }
        
        return true;
      }
    } catch (error) {
      console.error('恢复播放器状态失败:', error);
    }
    return false;
  }
  
  // 定期保存状态
  function setupAutoSave() {
    // 每5秒保存一次状态
    setInterval(savePlayerState, 5000);
    
    // 页面卸载时保存状态
    window.addEventListener('beforeunload', savePlayerState);
    
    // 页面隐藏时保存状态
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        savePlayerState();
      }
    });
  }
  
  // 创建音频元素
  function createAudioElement() {
    audioElement = new Audio();
    audioElement.addEventListener('timeupdate', updateProgress);
    audioElement.addEventListener('ended', playNext);
    audioElement.addEventListener('error', handleAudioError);
  }
  
  // 处理音频错误
  function handleAudioError() {
    console.error('音频播放失败:', audioElement.error);
    // 尝试下一首
    if (currentSongIndex < songs.length - 1) {
      playNext();
    }
  }
  
  // 更新进度
  function updateProgress() {
    if (audioElement && audioElement.duration) {
      const progress = (audioElement.currentTime / audioElement.duration) * 100;
      progressFill.style.width = progress + '%';
      
      currentTime.textContent = formatTime(Math.floor(audioElement.currentTime));
      totalTime.textContent = formatTime(Math.floor(audioElement.duration));
    }
  }
  
  // 播放当前歌曲
  function playCurrentSong() {
    if (songs.length > 0 && songs[currentSongIndex]) {
      const song = songs[currentSongIndex];
      
      if (!audioElement) {
        createAudioElement();
      }
      
      if (song.url) {
        audioElement.src = song.url;
        
        // 恢复播放位置
        const savedState = localStorage.getItem(MUSIC_PLAYER_STATE_KEY);
        if (savedState && isPlaying) {
          const state = JSON.parse(savedState);
          if (state.currentTime > 0) {
            audioElement.currentTime = state.currentTime;
          }
        }
        
        audioElement.play().then(() => {
          isPlaying = true;
          updatePlayButton();
        }).catch(error => {
          console.error('播放失败:', error);
          // 如果播放失败，尝试下一首
          if (currentSongIndex < songs.length - 1) {
            playNext();
          }
        });
      } else {
        console.error('歌曲URL为空:', song);
        // 如果URL为空，尝试下一首
        if (currentSongIndex < songs.length - 1) {
          playNext();
        }
      }
    }
  }
  
  // 播放下一首
  function playNext() {
    if (songs.length > 0) {
      currentSongIndex = (currentSongIndex + 1) % songs.length;
      updateSongInfo();
      updatePlaylist();
      if (isPlaying) {
        playCurrentSong();
      }
    }
  }
  
  // 播放上一首
  function playPrev() {
    if (songs.length > 0) {
      currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
      updateSongInfo();
      updatePlaylist();
      if (isPlaying) {
        playCurrentSong();
      }
    }
  }
  
  // 暂停播放
  function pauseCurrentSong() {
    if (audioElement) {
      audioElement.pause();
    }
    isPlaying = false;
    updatePlayButton();
  }
  
  // 更新播放按钮
  function updatePlayButton() {
    const icon = playBtn.querySelector('i');
    if (isPlaying) {
      icon.className = 'fas fa-pause';
      musicToggleBtn.classList.add('playing');
    } else {
      icon.className = 'fas fa-play';
      musicToggleBtn.classList.remove('playing');
    }
  }
  
  // 更新歌曲信息
  function updateSongInfo() {
    if (songs.length > 0 && songs[currentSongIndex]) {
      const song = songs[currentSongIndex];
      songTitle.textContent = song.title;
      songArtist.textContent = song.artist;
    }
  }
  
  // 更新播放列表
  function updatePlaylist() {
    playlistList.innerHTML = songs.map((song, index) => `
      <div class="playlist-item ${index === currentSongIndex ? 'active' : ''}" data-index="${index}">
        <div class="song-info">
          <div class="song-name">${song.title}</div>
          <div class="song-artist">${song.artist}</div>
        </div>
      </div>
    `).join('');
    
    // 添加点击事件
    document.querySelectorAll('.playlist-item').forEach(item => {
      item.addEventListener('click', function() {
        currentSongIndex = parseInt(this.dataset.index);
        updateSongInfo();
        updatePlaylist();
        if (isPlaying) {
          playCurrentSong();
        }
      });
    });
  }
  
  // 获取网易云歌单数据
  async function fetchPlaylist() {
    try {
      console.log('正在获取歌单数据...');
      // 从配置文件中获取歌单 ID
      const playlistId = '2993057618';
      console.log('使用歌单 ID:', playlistId);
      
      const response = await fetch(`https://api.injahow.cn/meting/?type=playlist&id=${playlistId}`);
      const data = await response.json();
      
      console.log('歌单数据:', data);
      
      if (data && data.length > 0) {
        songs = data.map(song => ({
          title: song.name || song.title,
          artist: song.artist || song.ar?.[0]?.name || '未知艺术家',
          url: song.url,
          pic: song.pic
        }));
        
        updatePlaylist();
        updateSongInfo();
        songCount.textContent = `${songs.length}首`;
      }
    } catch (error) {
      console.error('获取歌单失败:', error);
      // 使用备用数据
      songs = [
        { title: "加载失败", artist: "请检查网络", url: "", pic: "" }
      ];
      updatePlaylist();
      updateSongInfo();
    }
  }
  
  // 切换音乐面板
  if (musicToggleBtn && musicPanel) {
    musicToggleBtn.addEventListener('click', function() {
      console.log('音乐按钮被点击');
      musicPanel.classList.toggle('active');
      if (songs.length === 0) {
        fetchPlaylist().then(() => {
          // 歌单加载完成后，如果有保存的状态，恢复播放
          const stateRestored = restorePlayerState();
          if (stateRestored && songs.length > 0) {
            updateSongInfo();
            updatePlaylist();
            if (isPlaying) {
              playCurrentSong();
            }
          }
        });
      }
      savePlayerState(); // 保存面板状态
    });
  }
  
  // 点击面板外部关闭
  document.addEventListener('click', function(e) {
    if (musicPanel && !musicPanel.contains(e.target) && !musicToggleBtn.contains(e.target)) {
      musicPanel.classList.remove('active');
    }
  });
  
  // 播放控制
  if (playBtn) {
    playBtn.addEventListener('click', function() {
      if (isPlaying) {
        pauseCurrentSong();
      } else {
        playCurrentSong();
      }
    });
  }
  
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      playPrev();
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      playNext();
    });
  }
  
  // 页面初始化时恢复状态
  document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，初始化音乐播放器');
    
    // 尝试恢复保存的状态
    const stateRestored = restorePlayerState();
    
    // 如果有保存的状态，先加载歌单然后恢复播放
    if (stateRestored) {
      fetchPlaylist().then(() => {
        if (songs.length > 0) {
          updateSongInfo();
          updatePlaylist();
          if (isPlaying) {
            playCurrentSong();
          }
        }
      });
    }
    
    // 设置自动保存
    setupAutoSave();
  });
  
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
</script>

<style>
  .mini-music-player {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
  }
  
  .music-toggle-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .music-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
  }
  
  .music-toggle-btn.playing {
    animation: musicPulse 2s infinite;
  }
  
  .music-panel {
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 320px;
    max-height: 450px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .music-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .custom-player {
    padding: 16px;
  }
  
  .player-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .song-info {
    flex: 1;
    min-width: 0;
  }
  
  .song-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }
  
  .song-artist {
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .player-controls {
    display: flex;
    gap: 8px;
  }
  
  .control-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .control-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  }
  
  .progress-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px 0;
  }
  
  .progress-time {
    font-size: 0.7rem;
    color: #666;
    min-width: 30px;
    text-align: center;
  }
  
  .progress-track {
    flex: 1;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5, #3730a3);
    border-radius: 2px;
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .playlist-container {
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
  }
  
  .playlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    font-size: 0.8rem;
    font-weight: 600;
    color: #333;
    border-bottom: 1px solid #e9ecef;
  }
  
  .song-count {
    color: #666;
    font-size: 0.7rem;
  }
  
  .playlist-list {
    max-height: 180px;
    overflow-y: auto;
  }
  
  .playlist-item {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .playlist-item:hover {
    background: #f8f9fa;
  }
  
  .playlist-item.active {
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
  }
  
  .playlist-item .song-name {
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .playlist-item .song-artist {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .playlist-item.active .song-artist {
    opacity: 0.9;
  }
  
  @keyframes musicPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @media (prefers-color-scheme: dark) {
    .music-panel {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .progress-bar {
      background: #2d2d2d;
      color: #ccc;
    }
    
    .playlist-header {
      background: #2d2d2d;
      color: #fff;
      border-bottom-color: #404040;
    }
    
    .playlist-item {
      border-bottom-color: #404040;
      color: #fff;
    }
    
    .playlist-item:hover {
      background: #3d3d3d;
    }
  }
  
  @media (max-width: 768px) {
    .mini-music-player {
      bottom: 16px;
      left: 16px;
    }
    
    .music-panel {
      width: 300px;
      max-height: 400px;
    }
    
    .music-toggle-btn {
      width: 36px;
      height: 36px;
      font-size: 0.8rem;
    }
  }
</style>


  

  <!-- 主脚本 -->
  
<script src="/js/main.js"></script>


  
  
    <script>
      (function() {
        var defaults = {
          tex: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            tags: 'ams',
            packages: {'[+]': ['noerrors']}
          },
          options: {
            skipHtmlTags: ['noscript', 'style', 'textarea', 'pre', 'code'],
            renderActions: {
              addMenu: []
            }
          }
        };
        var userCfg = {"tex":{"inlineMath":[["$","$"],["\\\\(","\\\\)"]],"displayMath":[["$$","$$"],["\\\\[","\\\\]"]],"tags":"ams","packages":{"[+]":["noerrors"]}},"options":{"skipHtmlTags":["noscript","style","textarea","pre","code"],"ignoreHtmlClass":"tex2jax_ignore","processHtmlClass":"tex2jax_process"}};
        if (userCfg.tex) {
          userCfg.tex = Object.assign({}, defaults.tex, userCfg.tex);
        }
        if (userCfg.options) {
          userCfg.options = Object.assign({}, defaults.options, userCfg.options);
        }
        window.MathJax = Object.assign({}, defaults, userCfg);
      })();
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
