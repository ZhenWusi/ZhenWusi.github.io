<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- åŸºæœ¬ meta æ ‡ç­¾ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- SEO meta æ ‡ç­¾ -->
  <title>RLHF çš„ä¸‰é˜¶æ®µæµç¨‹ | ä¹ä¹çš„ä¸ªäººåšå®¢ | JiuJiu&#39;s Blog</title>
  <meta name="description" content="ä¸€ä¸ªçƒ­çˆ±æŠ€æœ¯çš„å¼€å‘è€…çš„ä¸ªäººåšå®¢ï¼Œåˆ†äº«ç¼–ç¨‹ã€æŠ€æœ¯å’Œç”Ÿæ´»æ„Ÿæ‚Ÿã€‚">
  <meta name="keywords" content="LLM">
  <meta name="author" content="ZhenWusi">

  <!-- Open Graph ç¤¾äº¤åˆ†äº« -->
  <meta property="og:title" content="RLHF çš„ä¸‰é˜¶æ®µæµç¨‹">
  <meta property="og:description" content="ä¸€ä¸ªçƒ­çˆ±æŠ€æœ¯çš„å¼€å‘è€…çš„ä¸ªäººåšå®¢ï¼Œåˆ†äº«ç¼–ç¨‹ã€æŠ€æœ¯å’Œç”Ÿæ´»æ„Ÿæ‚Ÿã€‚">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/index.html">
  <meta property="og:image" content="/img/%E5%A4%B4%E5%83%8F.jpg">
  <meta property="og:image:alt" content="ZhenWusiçš„å¤´åƒ">

  <!-- å›¾æ ‡ -->
  <link rel="icon" href="/img/å¤´åƒ.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="/img/å¤´åƒ.jpg">
  <link rel="shortcut icon" href="/img/å¤´åƒ.jpg">

  <!-- Google Fonts - Noto Sans SC -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

  <!-- Font Awesome å›¾æ ‡ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script defer src="https://code.iconify.design/iconify-icon/1.0.8/iconify-icon.min.js"></script>

  <!-- ä¸»æ ·å¼è¡¨ -->
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ä¹ä¹çš„ä¸ªäººåšå®¢ | JiuJiu's Blog" type="application/atom+xml">
</head>
<body>
  <!-- å…¨å±€åŠ è½½åŠ¨ç”» -->
  <div id="loading-mask">
    <div class="spinner"></div>
  </div>

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<header class="site-header" id="site-header">
  <div class="header-inner">
    <!-- æ¡Œé¢ç«¯å¯¼èˆªèœå• -->
    <nav class="site-nav" id="site-nav">
      
        <a href="/" class="nav-link">
          
            <iconify-icon icon="mingcute:home-2-fill"></iconify-icon>
          
          <span class="nav-text">é¦–é¡µ</span>
        </a>
      
        <a href="/archives" class="nav-link">
          
            <iconify-icon icon="mingcute:inbox-fill"></iconify-icon>
          
          <span class="nav-text">æ–‡ç« </span>
        </a>
      
        <a href="/about" class="nav-link">
          
            <iconify-icon icon="mingcute:user-info-fill"></iconify-icon>
          
          <span class="nav-text">å…³äº</span>
        </a>
      
        <a href="/categories" class="nav-link">
          
            <iconify-icon icon="mingcute:classify-2-fill"></iconify-icon>
          
          <span class="nav-text">åˆ†ç±»</span>
        </a>
      
        <a href="/tags" class="nav-link">
          
            <iconify-icon icon="mingcute:tag-fill"></iconify-icon>
          
          <span class="nav-text">æ ‡ç­¾</span>
        </a>
      
    </nav>

    <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
    <div class="header-actions">
      <!-- æœç´¢æŒ‰é’® -->
      <button class="action-btn" id="search-toggle" title="æœç´¢">
        <i class="fas fa-search"></i>
      </button>
      <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
      <button class="action-btn mobile-menu-btn" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </div>

  <!-- æœç´¢å¼¹çª— -->
  <div class="search-overlay" id="search-overlay">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="æœç´¢æ–‡ç« ..." autocomplete="off">
      <button id="search-close"><i class="fas fa-times"></i></button>
    </div>
    <div class="search-results" id="search-results"></div>
  </div>
</header>

<!-- ç§»åŠ¨ç«¯ä¾§æ»‘èœå• -->
<div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
<aside class="mobile-menu" id="mobile-menu">
  <div class="mobile-menu-header">
    
      <img src="/img/å¤´åƒ.jpg" alt="å¤´åƒ" class="mobile-avatar">
    
    <h3>ZhenWusi</h3>
    
      <p>é¾™å‡ºæµ·ï¼Œè™ä¸‹å±±â€¦â€¦ | Exploring code &amp; AI</p>
    
  </div>
  <nav class="mobile-nav">
    
      <a href="/" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:home-2-fill"></iconify-icon>
        
        <span class="nav-text">é¦–é¡µ</span>
      </a>
    
      <a href="/archives" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:inbox-fill"></iconify-icon>
        
        <span class="nav-text">æ–‡ç« </span>
      </a>
    
      <a href="/about" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:user-info-fill"></iconify-icon>
        
        <span class="nav-text">å…³äº</span>
      </a>
    
      <a href="/categories" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:classify-2-fill"></iconify-icon>
        
        <span class="nav-text">åˆ†ç±»</span>
      </a>
    
      <a href="/tags" class="mobile-nav-link">
        
          <iconify-icon icon="mingcute:tag-fill"></iconify-icon>
        
        <span class="nav-text">æ ‡ç­¾</span>
      </a>
    
  </nav>
</aside>


  <!-- é¡µé¢ä¸»å†…å®¹ -->
  <main class="main-content">
    <!-- æ–‡ç« è¯¦æƒ…é¡µå¸ƒå±€ -->



<!-- æ–‡ç« é¡¶éƒ¨æ¨ªå¹… -->
<section class="post-banner" style="background-image: url('/img/background/')">
  <div class="hero-overlay"></div>
  <div class="post-banner-content">
    <!-- åˆ†ç±» -->
    
      <div class="post-banner-cats">
        
          <a href="/categories/%E7%AE%97%E6%B3%95/"><i class="fas fa-folder"></i> ç®—æ³•</a>
        
      </div>
    
    <h1 class="post-banner-title">RLHF çš„ä¸‰é˜¶æ®µæµç¨‹</h1>
    <div class="post-banner-meta">
      <span><i class="far fa-calendar-alt"></i> 2026-02-23</span>
      <span><i class="far fa-clock"></i> é˜…è¯»çº¦ 2.4k å­—</span>
      
        <span><i class="fas fa-tags"></i>
          
          LLM
        </span>
      
    </div>
  </div>
</section>

<!-- æ–‡ç« ä¸»ä½“ -->
<div class="reading-progress"><span class="reading-progress__bar"></span></div>
<div class="container post-container">
  <div class="post-layout">
    <!-- æ–‡ç« å†…å®¹åŒºåŸŸ -->
    <article class="post-content-wrap">
      <!-- ç›®å½•ï¼ˆTOCï¼‰ -->
      
        <div class="post-toc-mobile" id="toc-mobile">
          <details>
            <summary><i class="fas fa-list"></i> æ–‡ç« ç›®å½•</summary>
            <div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">åŸºç¡€çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RLHF-%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B"><span class="toc-text">RLHF çš„ä¸‰é˜¶æ®µæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%80%EF%BC%9ASFT%EF%BC%88Supervised-Fine-Tuning%EF%BC%89"><span class="toc-text">é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised Fine-Tuningï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9A%E5%A5%96%E5%8A%B1%E6%A8%A1%E5%9E%8B%EF%BC%88Reward-Modeling%EF%BC%89"><span class="toc-text">é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelingï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%A7%A3%E9%87%8A"><span class="toc-text">è¡¥å……è§£é‡Š</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%89%EF%BC%9ARL-%E5%BE%AE%E8%B0%83"><span class="toc-text">é˜¶æ®µä¸‰ï¼šRL å¾®è°ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%A7%A3%E9%87%8A-1"><span class="toc-text">è¡¥å……è§£é‡Š</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96%EF%BC%88Direct-Preference-Optimization%EF%BC%89"><span class="toc-text">ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect Preference Optimizationï¼‰</span></a></li></ol></div>
          </details>
        </div>
      

      <!-- æ­£æ–‡ -->
      <div class="post-body markdown-body" id="post-body">
        <h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="RLHF-çš„ä¸‰é˜¶æ®µæµç¨‹"><a href="#RLHF-çš„ä¸‰é˜¶æ®µæµç¨‹" class="headerlink" title="RLHF çš„ä¸‰é˜¶æ®µæµç¨‹"></a>RLHF çš„ä¸‰é˜¶æ®µæµç¨‹</h3><p>RLHFï¼ˆReinforcement Learning from Human Feedbackï¼‰é€šå¸¸åŒ…å«ä¸‰ä¸ªä¸»è¦é˜¶æ®µï¼š</p>
<p><strong>ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰â†’ åå¥½é‡‡æ · + å¥–åŠ±æ¨¡å‹å­¦ä¹  â†’ å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–ï¼ˆRLï¼‰</strong></p>
<p>ç®€å•å¯ä»¥ç†è§£ä¸ºï¼šå…ˆå­¦â€æ€ä¹ˆè¯´è¯â€ï¼Œå†å­¦â€ä»€ä¹ˆè¯æ›´å¥½â€ï¼Œæœ€åé€¼æ¨¡å‹å¤šè¯´â€å¥½è¯â€</p>
<h4 id="é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised-Fine-Tuningï¼‰"><a href="#é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised-Fine-Tuningï¼‰" class="headerlink" title="é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised Fine-Tuningï¼‰"></a>é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised Fine-Tuningï¼‰</h4><p>RLHF é€šå¸¸ä»å¯¹ä¸€ä¸ªé¢„è®­ç»ƒè¯­è¨€æ¨¡å‹è¿›è¡Œç›‘ç£å¾®è°ƒå¼€å§‹ï¼Œä½¿ç”¨é«˜è´¨é‡çš„äººå·¥æ•°æ®ï¼ˆå¦‚å¯¹è¯ã€æ‘˜è¦ç­‰ï¼‰ï¼Œå¾—åˆ°ä¸€ä¸ªæ¨¡å‹ $ \pi_{SFT} $ã€‚</p>
<p><strong>æ•°æ®å½¢å¼</strong>ï¼š$ (\text{prompt } x, \text{é«˜è´¨é‡å›ç­” } y) $</p>
<p><strong>æŸå¤±å‡½æ•°</strong>ï¼šæ ‡å‡†çš„ç›‘ç£å­¦ä¹ æŸå¤±å‡½æ•°</p>
<script type="math/tex; mode=display">\max_{\theta} \sum_{(x,y) \in D} \log \pi_\theta(y|x)</script><ul>
<li>$ \pi_\theta $ï¼šç­–ç•¥æ¨¡å‹çš„å‚æ•°åŒ–å½¢å¼</li>
<li>$ D $ï¼šç›‘ç£å¾®è°ƒæ•°æ®é›†</li>
<li>$ x $ï¼šè¾“å…¥æç¤º</li>
<li>$ y $ï¼šç›®æ ‡å›ç­”</li>
</ul>
<p><strong>ç›®æ ‡</strong>ï¼šè®©æ¨¡å‹å­¦ä¼šåŸºæœ¬çš„å¯¹è¯èƒ½åŠ›å’Œä»»åŠ¡å®Œæˆèƒ½åŠ›ï¼Œå³â€æ€ä¹ˆè¯´è¯â€</p>
<h4 id="é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward-Modelingï¼‰"><a href="#é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward-Modelingï¼‰" class="headerlink" title="é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelingï¼‰"></a>é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelingï¼‰</h4><p>ä½¿ç”¨ SFT æ¨¡å‹ï¼Œå¯¹åŒä¸€ä¸ª prompt $ x $ é‡‡æ ·ä¸¤ä¸ªå›ç­”ï¼š</p>
<script type="math/tex; mode=display">y_1, y_2 \sim \pi_{SFT}(y|x)</script><p>äº¤ç»™äººç±»æ ‡æ³¨è€…ï¼Œè®©ä»–ä»¬é€‰æ›´å¥½çš„ä¸€ä¸ªï¼š</p>
<script type="math/tex; mode=display">y_w \succ y_l \mid x</script><ul>
<li>$ y_w $ï¼šwinner,preferredï¼ˆèµ¢å®¶ï¼‰</li>
<li>$ y_l $ï¼šloser,rejectedï¼ˆè¾“å®¶ï¼‰</li>
</ul>
<p><strong>æ½œåœ¨å¥–åŠ±å‡½æ•°å‡è®¾</strong>ï¼šå‡è®¾äººç±»åå¥½æ˜¯ç”±ä¸€ä¸ªæœªçŸ¥çš„çœŸå®å¥–åŠ±å‡½æ•° $ r^*(x,y) $ ç”Ÿæˆçš„ã€‚æˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒï¼Œä½†å‡è®¾å®ƒå­˜åœ¨ã€‚</p>
<p><strong>åå¥½æ¨¡å‹</strong>ï¼š</p>
<script type="math/tex; mode=display">p^*(y_1 > y_2 | x) = \frac{\exp(r^*(x, y_1))}{\exp(r^*(x, y_1)) + \exp(r^*(x, y_2))} \tag{1}</script><p><strong>æ•°æ®é›†å½¢å¼</strong>ï¼š</p>
<script type="math/tex; mode=display">D = \{(x^{(i)}, y_w^{(i)}, y_l^{(i)})\}_{i=1}^N</script><p><strong>æŸå¤±å‡½æ•°</strong>ï¼š</p>
<script type="math/tex; mode=display">\mathcal{L}_\text{R}(r_\phi, \mathcal{D}) = -\mathbb{E}_{(x, y_w, y_l) \sim \mathcal{D}} \left[ \log \sigma (r_\phi(x, y_w) - r_\phi(x, y_l)) \right] \tag{2}</script><hr>
<h5 id="è¡¥å……è§£é‡Š"><a href="#è¡¥å……è§£é‡Š" class="headerlink" title="è¡¥å……è§£é‡Š"></a>è¡¥å……è§£é‡Š</h5><p>BT æ¨¡å‹ï¼š</p>
<p>Bradley-Terry æ¨¡å‹æ˜¯ä¸€ä¸ªç”¨äº<strong>æˆå¯¹æ¯”è¾ƒ</strong>çš„æ¦‚ç‡æ¨¡å‹</p>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<ul>
<li>æ¯ä¸ªå¯¹è±¡ $ i $ æœ‰ä¸€ä¸ªéšè—çš„â€å®åŠ›å€¼â€å‚æ•° $ \lambda_i $</li>
<li>å½“ä¸¤ä¸ªå¯¹è±¡ $ i $ å’Œ $ j $ æ¯”è¾ƒæ—¶ï¼Œ$ i $ æˆ˜èƒœ $ j $ çš„æ¦‚ç‡ä¸ºï¼š</li>
</ul>
<script type="math/tex; mode=display">P(i \succ j) = \frac{\lambda_i}{\lambda_i + \lambda_j}</script><p><strong>åœ¨ DPO ä¸­çš„åº”ç”¨</strong>ï¼š</p>
<ul>
<li>å°†å¥–åŠ±å‡½æ•° $ r(x,y) $ çœ‹ä½œâ€å®åŠ›å€¼â€</li>
<li>äººç±»åå¥½ $ y_w \succ y_l $ å°±æ˜¯â€æ¯”è¾ƒç»“æœâ€</li>
<li>é€šè¿‡ BT æ¨¡å‹å»ºç«‹å¥–åŠ±ä¸åå¥½çš„æ¡¥æ¢</li>
</ul>
<p>ä¸ºä»€ä¹ˆä¸ç”¨ã€Œè°åˆ†æ•°å¤§å°±é€‰è°ã€ï¼Ÿ</p>
<p>å¦‚æœç›´æ¥è§„å®šï¼š<script type="math/tex">y_1 \succ y_2 \iff r^*(x,y_1) > r^*(x,y_2)</script><br>é‚£é—®é¢˜æ˜¯ï¼šäººç±»åˆ¤æ–­æœ‰å™ªå£°ï¼ŒåŒä¸€ä¸ªäººã€åŒä¸€ä¸ªé—®é¢˜ï¼Œä¸ä¸€å®šæ¯æ¬¡é€‰åŒæ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸å»ºæ¨¡æˆç¡®å®šæ€§è§„åˆ™ï¼Œè€Œæ˜¯ï¼šæ¦‚ç‡æ¨¡å‹</p>
<p>æŠŠå…¬å¼ (1) æ”¹å†™ä¸€ä¸‹ï¼š</p>
<script type="math/tex; mode=display">p^*(y_1 \succ y_2 \mid x) = \frac{1}{1 + e^{-(r^*(x,y_1) - r^*(x,y_2))}}</script><p>è¿™å°±æ˜¯ç†Ÿæ‚‰çš„ Sigmoid å‡½æ•°ï¼š</p>
<script type="math/tex; mode=display">\sigma(z) = \frac{1}{1 + e^{-z}}</script><p>äºæ˜¯ï¼š</p>
<script type="math/tex; mode=display">p^*(y_1 \succ y_2 \mid x) = \sigma(r^*(x,y_1) - r^*(x,y_2))</script><p>å› ä¸ºçœŸå®æ•°æ®é‡Œäººç¡®å®é€‰æ‹©äº† $ y_w $ï¼Œæ‰€ä»¥è¯¥äº‹ä»¶çš„æ¦‚ç‡æ˜¯ä¸Šå¼ï¼Œå¯¹æ•°ä¼¼ç„¶æ˜¯ï¼š</p>
<script type="math/tex; mode=display">\log p_\theta(y_w \succ y_l \mid x) = \log \sigma(r_\theta(x,y_w) - r_\theta(x,y_l))</script><p>æœ€å¤§åŒ–æ‰€æœ‰æ ·æœ¬çš„å¯¹æ•°ä¼¼ç„¶ï¼š</p>
<script type="math/tex; mode=display">\max_\theta \sum_{i=1}^N \log \sigma(r_\theta(x^{(i)}, y_w^{(i)}) - r_\theta(x^{(i)}, y_l^{(i)}))</script><p>æ„æ€æ˜¯ï¼šå¯¹æ¯ä¸€æ¡æ•°æ®ï¼Œéƒ½ç®—ä¸€æ¬¡â€æ¨¡å‹è®¤ä¸ºäººç±»ä¼šé€‰èµ¢å®¶çš„æ¦‚ç‡çš„å¯¹æ•°â€ï¼Œç„¶åæŠŠå®ƒä»¬åŠ èµ·æ¥ï¼Œè®©è¿™ä¸ªæ€»å’Œå°½å¯èƒ½å¤§ã€‚å¯¹æ•°æŠŠâ€œè¿ä¹˜â€å˜æˆâ€œè¿åŠ â€,æœ€ä¼˜è§£ä¸å˜(å¯¹æ•°æ˜¯å•è°ƒé€’å¢å‡½æ•°)</p>
<p>ç­‰ä»·åœ°ï¼Œæœ€å°åŒ–è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼ˆLikelihoodï¼‰ï¼š</p>
<script type="math/tex; mode=display">L_R = -\mathbb{E}_{(x,y_w,y_l) \sim D} [\log \sigma(r_\theta(x,y_w) - r_\theta(x,y_l))]</script><p>è¿™æ­£æ˜¯å…¬å¼ (2)ã€‚æ„æ€æ˜¯ï¼šå¯¹æ•°æ®é›†é‡Œçš„æ ·æœ¬å–å¹³å‡ï¼Œç„¶åå¯¹â€å¯¹æ•°æ¦‚ç‡â€å–è´Ÿå·ï¼Œè®©è¿™ä¸ªå€¼å°½å¯èƒ½å°ã€‚</p>
<p>å¯¹ä¸€ä¸ªæœ‰é™æ•°æ®é›† $ D = {z_1, â€¦, z_N} $ï¼Œå¦‚æœä½ å‡åŒ€éšæœºä»ä¸­æŠ½ä¸€ä¸ªæ ·æœ¬ï¼Œé‚£ä¹ˆï¼š</p>
<script type="math/tex; mode=display">\mathbb{E}_{z \sim D} [f(z)] = \frac{1}{N} \sum_{i=1}^N f(z_i)</script><p>ğŸ‘‰ æœŸæœ› = å¹³å‡å€¼</p>
<p>ä»¤ $ f(x,y<em>w,y_l) = \log \sigma(r</em>\theta(x,y<em>w) - r</em>\theta(x,y_l)) $ é‚£ä¹ˆï¼š</p>
<script type="math/tex; mode=display">\mathbb{E}_{(x,y_w,y_l) \sim D} [f] = \frac{1}{N} \sum_{i=1}^N \log \sigma(r_\theta(x^{(i)}, y_w^{(i)}) - r_\theta(x^{(i)}, y_l^{(i)}))</script><p>å› ä¸º $ \sum<em>{i=1}^N f_i $ å’Œ $ \frac{1}{N} \sum</em>{i=1}^N f<em>i $ åªå·®ä¸€ä¸ªå¸¸æ•° $ \frac{1}{N} $ã€‚è€Œåœ¨ä¼˜åŒ–ä¸­ï¼šä¹˜ä»¥ä¸€ä¸ªæ­£çš„å¸¸æ•°ï¼Œä¸ä¼šæ”¹å˜æœ€ä¼˜è§£çš„ä½ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š$$ \arg\max</em>\theta \sum<em>{i=1}^N f_i = \arg\max</em>\theta \frac{1}{N} \sum_{i=1}^N f_i $$</p>
<p>åŸç›®æ ‡ï¼š$ \max_\theta \mathbb{E}_D [\log \sigma(\cdots)] $</p>
<p>ç­‰ä»·äºï¼š$ \min_\theta -\mathbb{E}_D [\log \sigma(\cdots)] $</p>
<p>äºæ˜¯å®šä¹‰ï¼š$ L_R = -\mathbb{E}_D [\log \sigma(\cdots)] $</p>
<p><strong>ä¸ºä»€ä¹ˆæœºå™¨å­¦ä¹ é‡Œâ€æ€»æ˜¯æœ€å°åŒ–â€ï¼Ÿ</strong></p>
<p>å› ä¸ºæ¢¯åº¦ä¸‹é™ï¼ˆGradient Descentï¼‰é»˜è®¤æ˜¯ minimize lossï¼Œæ‰€ä»¥å¤§å®¶ä¹ æƒ¯ï¼šæŠŠâ€æƒ³æœ€å¤§åŒ–çš„ç›®æ ‡â€ï¼Œå†™æˆâ€è¦æœ€å°åŒ–çš„æŸå¤±â€ã€‚</p>
<hr>
<h4 id="é˜¶æ®µä¸‰ï¼šRL-å¾®è°ƒ"><a href="#é˜¶æ®µä¸‰ï¼šRL-å¾®è°ƒ" class="headerlink" title="é˜¶æ®µä¸‰ï¼šRL å¾®è°ƒ"></a>é˜¶æ®µä¸‰ï¼šRL å¾®è°ƒ</h4><p><strong>RL ç›®æ ‡å‡½æ•°ï¼ˆæ ¸å¿ƒï¼‰</strong>ï¼š</p>
<script type="math/tex; mode=display">\max_{\pi_\theta} \mathbb{E}_{x \sim \mathcal{D}, y \sim \pi_\theta(y|x)} \left[ r_\phi(x, y) - \beta D_{\text{KL}} \left[ \pi_\theta(y|x) \middle\| \pi_{\text{ref}}(y|x) \right] \right] \tag{3}</script><hr>
<h5 id="è¡¥å……è§£é‡Š-1"><a href="#è¡¥å……è§£é‡Š-1" class="headerlink" title="è¡¥å……è§£é‡Š"></a>è¡¥å……è§£é‡Š</h5><p>ä¸€å¥è¯è§£é‡Šï¼šğŸ‘‰ è®©æ¨¡å‹ç”Ÿæˆ å¥–åŠ±é«˜çš„å›ç­” ğŸ‘‰ ä½†ä¸èƒ½åç¦»åŸå§‹ SFT æ¨¡å‹å¤ªè¿œ</p>
<p>$ \pi<em>{ref} $ï¼ˆå³åˆå§‹ SFT æ¨¡å‹ $ \pi</em>{SFT} $ï¼‰å®è·µä¸­ï¼Œè¯­è¨€æ¨¡å‹ç­–ç•¥ $ \pi<em>\theta $ ä¹Ÿè¢«åˆå§‹åŒ–ä¸º $ \pi</em>{SFT} $ã€‚</p>
<ul>
<li><strong>åˆå§‹çŠ¶æ€</strong>ï¼š$ \pi<em>\theta = \pi</em>{ref} = \pi_{SFT} $</li>
<li><strong>è®­ç»ƒç›®æ ‡</strong>ï¼šåœ¨ä¿æŒä¸åŸå§‹ SFT æ¨¡å‹æ¥è¿‘çš„å‰æä¸‹ï¼Œä¼˜åŒ–å¥–åŠ±</li>
<li><strong>KL çº¦æŸä½œç”¨</strong>ï¼šç¡®ä¿æ¨¡å‹ä¸ä¼šåç¦»åˆå§‹èƒ½åŠ›å¤ªè¿œ</li>
</ul>
<p><strong>KL çº¦æŸï¼š</strong></p>
<p>KL æ•£åº¦ï¼ˆKullback-Leibler æ•£åº¦ï¼‰è¡¡é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ï¼š</p>
<script type="math/tex; mode=display">D_{\text{KL}}[P \| Q] = \sum_x P(x) \log \frac{P(x)}{Q(x)}</script><script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta(y|x) \| \pi_{SFT}(y|x)] = \mathbb{E}_{y \sim \pi_\theta} \left[ \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)} \right]</script><p>è¿™è¡¨ç¤ºï¼š</p>
<ul>
<li>å¦‚æœ $ \pi<em>\theta $ å’Œ $ \pi</em>{SFT} $ ç›¸åŒï¼šKL = 0</li>
<li>å¦‚æœ $ \pi<em>\theta $ åç¦» $ \pi</em>{SFT} $ï¼šKL &gt; 0</li>
<li>ç›®æ ‡å‡½æ•°ä¸­çš„ $ -\beta KL $ æƒ©ç½šåç¦»è¡Œä¸º</li>
</ul>
<p><strong>KL æ•£åº¦æ¨å¯¼è¿‡ç¨‹è¯¦è§£</strong></p>
<p><strong>KL æ•£åº¦çš„é€šç”¨å®šä¹‰ï¼ˆç¦»æ•£å‹ï¼‰</strong>ï¼š</p>
<script type="math/tex; mode=display">D_{\text{KL}}[P \| Q] = \sum_i P(i) \log \frac{P(i)}{Q(i)}</script><p><strong>æœŸæœ›çš„å®šä¹‰</strong>ï¼š<br>å¯¹äºéšæœºå˜é‡ $ Y \sim P $ï¼Œå‡½æ•° $ f(Y) $ çš„æœŸæœ›å®šä¹‰ä¸ºï¼š</p>
<script type="math/tex; mode=display">\mathbb{E}_{Y \sim P}[f(Y)] = \sum_{y \in \mathcal{Y}} P(y) f(y)</script><p><strong>è¿›è¡Œå˜é‡æ˜ å°„</strong></p>
<p>åœ¨ RLHF çš„è¯­å¢ƒä¸‹ï¼Œæˆ‘ä»¬è¦è®¡ç®—çš„æ˜¯ä¸¤ä¸ªæ¨¡å‹ç­–ç•¥ï¼ˆæ¦‚ç‡åˆ†å¸ƒï¼‰ä¹‹é—´çš„å·®å¼‚ï¼š</p>
<ul>
<li>$ P $<strong> (å½“å‰åˆ†å¸ƒ)</strong>ï¼š$ \pi_\theta(y|x) $ â€”â€” æ¨¡å‹å½“å‰æ­£åœ¨å­¦ä¹ çš„ç­–ç•¥</li>
<li>$ Q $<strong> (å‚è€ƒåˆ†å¸ƒ)</strong>ï¼š$ \pi_{SFT}(y|x) $ â€”â€” åŸå§‹çš„ SFT ç­–ç•¥</li>
<li><strong>æ ·æœ¬ç©ºé—´</strong>ï¼š$ y $ï¼ˆæ¨¡å‹ç”Ÿæˆçš„æ‰€æœ‰å¯èƒ½çš„å›ç­”åºåˆ—ï¼‰</li>
</ul>
<p>å°†è¿™äº›ä»£å…¥é€šç”¨å…¬å¼ï¼š</p>
<script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta \| \pi_{SFT}] = \sum_y \pi_\theta(y|x) \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)}</script><p><strong>è½¬åŒ–ä¸ºæœŸæœ›å½¢å¼</strong></p>
<ul>
<li>å¤–å±‚çš„ $ \sum<em>y \pi</em>\theta(y|x)(\cdots) $ è¡¨ç¤ºæˆ‘ä»¬åœ¨æŒ‰ç…§ $ \pi_\theta(y|x) $ çš„æ¦‚ç‡åˆ†å¸ƒå¯¹åé¢çš„é¡¹è¿›è¡ŒåŠ æƒå¹³å‡</li>
<li>æ‹¬å·é‡Œçš„é¡¹ $ \log \frac{\pi<em>\theta(y|x)}{\pi</em>{SFT}(y|x)} $ å°±æ˜¯è¦è®¡ç®—æœŸæœ›çš„å¯¹è±¡</li>
</ul>
<p>å› æ­¤ï¼Œæ ¹æ®æœŸæœ›çš„å®šä¹‰ $ \sum P \cdot f = \mathbb{E}_P[f] $ï¼Œå¯ä»¥ç›´æ¥å†™æˆï¼š</p>
<script type="math/tex; mode=display">D_{\text{KL}}[\pi_\theta \| \pi_{SFT}] = \mathbb{E}_{y \sim \pi_\theta(y|x)} \left[ \log \frac{\pi_\theta(y|x)}{\pi_{SFT}(y|x)} \right]</script><p><strong>ä¸ºä»€ä¹ˆå®è·µä¸­è¦å†™æˆæœŸæœ›å½¢å¼ï¼Ÿ</strong></p>
<p>åœ¨æ·±åº¦å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ä¸­ï¼Œå†™æˆæœŸæœ›å½¢å¼æœ‰é‡å¤§çš„å·¥ç¨‹æ„ä¹‰ï¼š</p>
<p><strong>æ— æ³•å…¨é‡æ±‚å’Œ</strong>ï¼š<br>å¯¹äºè¯­è¨€æ¨¡å‹ï¼Œå¯èƒ½çš„å›ç­” $ y $ çš„ç»„åˆæ˜¯å¤©æ–‡æ•°å­—ï¼ˆç”±è¯è¡¨å¤§å°å’Œåºåˆ—é•¿åº¦å†³å®šï¼‰ï¼Œæˆ‘ä»¬æ ¹æœ¬æ— æ³•éå†æ‰€æœ‰çš„ $ y $ æ¥è®¡ç®—é‚£ä¸ª $ \sum $ ç¬¦å·ã€‚</p>
<p><strong>è’™ç‰¹å¡æ´›é‡‡æ ·ï¼ˆMonte Carlo Samplingï¼‰</strong>ï¼š<br>æœŸæœ›å½¢å¼å‘Šè¯‰æˆ‘ä»¬ï¼Œè™½ç„¶ä¸èƒ½éå†æ‰€æœ‰ç»“æœï¼Œä½†å¯ä»¥é€šè¿‡é‡‡æ ·æ¥è¿‘ä¼¼ï¼šè®©æ¨¡å‹ $ \pi<em>\theta $ ç”Ÿæˆï¼ˆSampleï¼‰ä¸€æ‰¹å¥å­ $ y $,è®¡ç®—è¿™äº›å¥å­çš„ $ \log \pi</em>\theta(y|x) - \log \pi_{SFT}(y|x) $,å–è¿™äº›å€¼çš„å¹³å‡å€¼ï¼Œå°±æ˜¯å¯¹ KL æ•£åº¦çš„æ— åä¼°è®¡</p>
<p><strong>å¯¹é½ç›®æ ‡å‡½æ•°</strong>ï¼š<br>RL çš„ç›®æ ‡å‡½æ•°æœ¬èº«å°±æ˜¯æœ€å¤§åŒ–æœŸæœ›å¥–åŠ± $ \mathbb{E}<em>{y \sim \pi</em>\theta}[r(x,y)] $ã€‚å°† KL çº¦æŸä¹Ÿå†™æˆæœŸæœ›å½¢å¼ï¼Œå°±å¯ä»¥åˆå¹¶åˆ°ä¸€ä¸ªå¤§æ‹¬å·é‡Œï¼š</p>
<p>$ \max<em>{\pi</em>\theta} \mathbb{E}<em>{y \sim \pi</em>\theta} \left[ r(x,y) - \beta \log \frac{\pi<em>\theta(y|x)}{\pi</em>{SFT}(y|x)} \right] $</p>
<p>è¿™æ ·ï¼Œæ¨¡å‹åœ¨æ¯ä¸€è½®è®­ç»ƒé‡‡æ ·æ—¶ï¼Œå°±å¯ä»¥åŒæ—¶ä¼˜åŒ–å¥–åŠ±å¹¶è®¡ç®— KL æƒ©ç½šã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¿™ä¸ªç›®æ ‡å‡½æ•°ä¸å¯å¯¼ï¼Ÿ</strong></p>
<p>è¯­è¨€æ¨¡å‹æ˜¯<strong>ç¦»æ•£ç”Ÿæˆ</strong>çš„ï¼š</p>
<ul>
<li>è¾“å‡ºæ˜¯ token åºåˆ— $ y = (y_1, y_2, \ldots) $</li>
<li>é‡‡æ · / argmax éƒ½æ˜¯ç¦»æ•£æ“ä½œ</li>
</ul>
<p>æ— æ³•åƒæ™®é€šç›‘ç£å­¦ä¹ é‚£æ ·ï¼Œå¯¹ $ \mathbb{E}<em>{y \sim \pi</em>\theta(y|x)}[r(x,y)] $ ç›´æ¥å¯¹ $ \theta $ æ±‚æ¢¯åº¦ã€‚</p>
<p>ğŸ‘‰ æ‰€ä»¥ä¸èƒ½ç”¨åå‘ä¼ æ’­ç›´æ¥ä¼˜åŒ–å¥–åŠ±<br>ğŸ‘‰ å¿…é¡»ç”¨å¼ºåŒ–å­¦ä¹ ï¼ˆpolicy gradientï¼‰</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ç”¨ REINFORCE / PPOã€‚</p>
<p><strong>KL çº¦æŸæ˜¯æ€ä¹ˆå˜æˆâ€å¥–åŠ±â€çš„ï¼Ÿ</strong></p>
<p><strong>å…³é”®ä¸€æ­¥æ˜¯ï¼šæŠŠå…¬å¼ (3) KL é¡¹å†™æˆ log-prob çš„å½¢å¼</strong></p>
<p>å¯¹ç¦»æ•£ç­–ç•¥ï¼š</p>
<p>$ D<em>{\text{KL}}(\pi</em>\theta | \pi<em>{ref}) = \mathbb{E}</em>{y \sim \pi<em>\theta} \left[ \log \pi</em>\theta(y|x) - \log \pi_{ref}(y|x) \right] $</p>
<p><strong>ä»£å›ç›®æ ‡å‡½æ•°</strong>ï¼š</p>
<p>$ \mathbb{E}<em>{y \sim \pi</em>\theta} \left[ r<em>\phi(x, y) - \beta \left( \log \pi</em>\theta(y|x) - \log \pi_{ref}(y|x) \right) \right] $</p>
<p><strong>äºæ˜¯å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°çš„ reward</strong>ï¼š</p>
<p>$ r(x, y) = r<em>\phi(x, y) - \beta \left( \log \pi</em>\theta(y|x) - \log \pi_{ref}(y|x) \right) $</p>
<p>å³è®ºæ–‡ä¸­çš„ï¼š</p>
<p>$ r(x, y) = r<em>\phi(x, y) - \left( \log \pi</em>\theta(y|x) - \log \pi_{ref}(y|x) \right) $</p>
<p>ï¼ˆè®ºæ–‡é‡Œé€šå¸¸æŠŠ $ \beta $ çœç•¥æˆ–å¸æ”¶åˆ°ç³»æ•°é‡Œï¼‰</p>
<p><strong>è½¬æ¢åçš„ç®€åŒ–ç›®æ ‡å‡½æ•°</strong></p>
<p>é€šè¿‡è¿™ä¸ªå˜æ¢ï¼ŒåŸæ¥çš„çº¦æŸä¼˜åŒ–é—®é¢˜å˜æˆäº†æ— çº¦æŸçš„å¥–åŠ±æœ€å¤§åŒ–é—®é¢˜ï¼š</p>
<p>$ \max<em>{\pi</em>\theta} \mathbb{E}<em>{x \sim \mathcal{D}, y \sim \pi</em>\theta(y|x)} \left[ r(x, y) \right] $</p>
<p>å…¶ä¸­ $ r(x, y) $ å·²ç»åŒ…å«äº† KL æƒ©ç½šé¡¹ã€‚</p>
<hr>
<h2 id="ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect-Preference-Optimizationï¼‰"><a href="#ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect-Preference-Optimizationï¼‰" class="headerlink" title="ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect Preference Optimizationï¼‰"></a>ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect Preference Optimizationï¼‰</h2>
      </div>

      <!-- ç‰ˆæƒå£°æ˜ -->
      
        <div class="post-copyright">
          <p><strong><i class="fas fa-copyright"></i> ç‰ˆæƒå£°æ˜</strong></p>
          <p>æœ¬æ–‡ä½œè€…ï¼šZhenWusi</p>
          <p>æœ¬æ–‡é“¾æ¥ï¼š<a href="https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/">https://zhenwusi.github.io/2026/02/23/RLHF%20%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B/</a></p>
          <p>é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œæœ¬ç«™æ‰€æœ‰æ–‡ç« å‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
        </div>
      

      <!-- æ–‡ç« æ ‡ç­¾ -->
      
        <div class="post-tags">
          
            <a href="/tags/LLM/" class="tag-item">
              <i class="fas fa-hashtag"></i>LLM
            </a>
          
        </div>
      

      <!-- ä¸Šä¸€ç¯‡ / ä¸‹ä¸€ç¯‡å¯¼èˆª -->
      <nav class="post-nav">
        
          <a href="/2026/02/23/%E5%8A%9B%E6%89%A3/" class="post-nav-item prev">
            <span class="post-nav-label"><i class="fas fa-chevron-left"></i> ä¸Šä¸€ç¯‡</span>
            <span class="post-nav-title">åŠ›æ‰£ 88ï¼šåˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</span>
          </a>
        
        
          <span class="post-nav-item next disabled"></span>
        
      </nav>

      <!-- è¯„è®ºåŒº -->
      <!-- è¯„è®ºç³»ç»Ÿç»„ä»¶ -->


    </article>

    <!-- ä¾§è¾¹æ ç›®å½•ï¼ˆæ¡Œé¢ç«¯ï¼‰ -->
    
      <aside class="post-sidebar" id="post-sidebar">
        <div class="sidebar-toc">
          <h3><i class="fas fa-list"></i> æ–‡ç« ç›®å½•</h3>
          <div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">åŸºç¡€çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RLHF-%E7%9A%84%E4%B8%89%E9%98%B6%E6%AE%B5%E6%B5%81%E7%A8%8B"><span class="toc-text">RLHF çš„ä¸‰é˜¶æ®µæµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%80%EF%BC%9ASFT%EF%BC%88Supervised-Fine-Tuning%EF%BC%89"><span class="toc-text">é˜¶æ®µä¸€ï¼šSFTï¼ˆSupervised Fine-Tuningï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9A%E5%A5%96%E5%8A%B1%E6%A8%A1%E5%9E%8B%EF%BC%88Reward-Modeling%EF%BC%89"><span class="toc-text">é˜¶æ®µäºŒï¼šå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelingï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%A7%A3%E9%87%8A"><span class="toc-text">è¡¥å……è§£é‡Š</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%89%EF%BC%9ARL-%E5%BE%AE%E8%B0%83"><span class="toc-text">é˜¶æ®µä¸‰ï¼šRL å¾®è°ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E8%A7%A3%E9%87%8A-1"><span class="toc-text">è¡¥å……è§£é‡Š</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96%EF%BC%88Direct-Preference-Optimization%EF%BC%89"><span class="toc-text">ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDirect Preference Optimizationï¼‰</span></a></li></ol></div>
        </div>
      </aside>
    
  </div>
</div>

  </main>

  <!-- é¡µè„š -->
  <!-- é¡µè„šåŒºåŸŸ -->
<footer class="site-footer">
  <div class="footer-inner">
    <!-- é¡µè„šä¿¡æ¯ -->
    <div class="footer-info">
      <p>
        &copy; 2025 - 2026
        <a href="/">ZhenWusi</a>
      </p>
      <p class="footer-powered">
        
          ç”± <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ |
          ä¸»é¢˜ <a href="/">NINE</a>
        
      </p>
      
    </div>

    <!-- é¡µè„šç¤¾äº¤é“¾æ¥ -->
    <div class="footer-social">
      
      
        
        <a href="https://github.com/ZhenWusi" target="_blank" rel="noopener" title="Github">
          
            <iconify-icon icon="mingcute:github-fill"></iconify-icon>
          
        </a>
      
        
        <a href="https://www.zhihu.com" target="_blank" rel="noopener" title="ZhiHu">
          
            <iconify-icon icon="ri:zhihu-line"></iconify-icon>
          
        </a>
      
        
        <a href="https://twitter.com" target="_blank" rel="noopener" title="Twitter">
          
            <iconify-icon icon="mingcute:social-x-fill"></iconify-icon>
          
        </a>
      
      <a href="/atom.xml" target="_blank" title="RSS è®¢é˜…">
        <i class="fas fa-rss"></i>
      </a>
    </div>
  </div>
</footer>


  <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
  <button id="back-to-top" title="å›åˆ°é¡¶éƒ¨">
    <i class="fas fa-chevron-up"></i>
  </button>

  <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
  
    <!-- å·¦ä¸‹è§’éŸ³ä¹æ’­æ”¾å™¨ -->

<div class="mini-music-player" id="mini-music-player">
  <!-- éŸ³ä¹æŒ‰é’® -->
  <button class="music-toggle-btn" id="music-toggle-btn" title="éŸ³ä¹æ’­æ”¾å™¨">
    <i class="fas fa-music"></i>
  </button>

  <!-- æ’­æ”¾å™¨é¢æ¿ -->
  <div class="music-panel" id="music-panel">
    <div class="music-content">
      <!-- è‡ªå®šä¹‰æ’­æ”¾å™¨ -->
      <div class="custom-player">
        <div class="player-header">
          <div class="song-info">
            <div class="song-title" id="song-title">åŠ è½½ä¸­...</div>
            <div class="song-artist" id="song-artist">è¯·ç¨å€™</div>
          </div>
          <div class="player-controls">
            <button class="control-btn" id="prev-btn" title="ä¸Šä¸€é¦–">
              <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-btn play-btn" id="play-btn" title="æ’­æ”¾/æš‚åœ">
              <i class="fas fa-play"></i>
            </button>
            <button class="control-btn" id="next-btn" title="ä¸‹ä¸€é¦–">
              <i class="fas fa-step-forward"></i>
            </button>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-time" id="current-time">0:00</div>
          <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-time" id="total-time">0:00</div>
        </div>
        
        <div class="playlist-container">
          <div class="playlist-header">
            <span>æ­Œå•åˆ—è¡¨</span>
            <span class="song-count" id="song-count">0é¦–</span>
          </div>
          <div class="playlist-list" id="playlist-list">
            <!-- æ­Œæ›²åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // éŸ³ä¹æ’­æ”¾å™¨æ§åˆ¶
  const musicToggleBtn = document.getElementById('music-toggle-btn');
  const musicPanel = document.getElementById('music-panel');
  const playBtn = document.getElementById('play-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const songTitle = document.getElementById('song-title');
  const songArtist = document.getElementById('song-artist');
  const currentTime = document.getElementById('current-time');
  const totalTime = document.getElementById('total-time');
  const progressFill = document.getElementById('progress-fill');
  const playlistList = document.getElementById('playlist-list');
  const songCount = document.getElementById('song-count');
  
  let songs = [];
  let currentSongIndex = 0;
  let isPlaying = false;
  let audioElement = null;
  
  // éŸ³ä¹æ’­æ”¾å™¨çŠ¶æ€ç®¡ç†
  const MUSIC_PLAYER_STATE_KEY = 'musicPlayerState';
  
  // ä¿å­˜æ’­æ”¾å™¨çŠ¶æ€
  function savePlayerState() {
    const state = {
      currentSongIndex: currentSongIndex,
      isPlaying: isPlaying,
      currentTime: audioElement ? audioElement.currentTime : 0,
      panelVisible: musicPanel ? musicPanel.classList.contains('active') : false
    };
    localStorage.setItem(MUSIC_PLAYER_STATE_KEY, JSON.stringify(state));
    console.log('ä¿å­˜æ’­æ”¾å™¨çŠ¶æ€:', state);
  }
  
  // æ¢å¤æ’­æ”¾å™¨çŠ¶æ€
  function restorePlayerState() {
    try {
      const savedState = localStorage.getItem(MUSIC_PLAYER_STATE_KEY);
      if (savedState) {
        const state = JSON.parse(savedState);
        console.log('æ¢å¤æ’­æ”¾å™¨çŠ¶æ€:', state);
        
        // æ¢å¤æ­Œæ›²ç´¢å¼•
        if (state.currentSongIndex !== undefined) {
          currentSongIndex = state.currentSongIndex;
        }
        
        // æ¢å¤æ’­æ”¾çŠ¶æ€
        if (state.isPlaying !== undefined) {
          isPlaying = state.isPlaying;
        }
        
        // æ¢å¤é¢æ¿æ˜¾ç¤ºçŠ¶æ€
        if (state.panelVisible && musicPanel) {
          musicPanel.classList.add('active');
        }
        
        return true;
      }
    } catch (error) {
      console.error('æ¢å¤æ’­æ”¾å™¨çŠ¶æ€å¤±è´¥:', error);
    }
    return false;
  }
  
  // å®šæœŸä¿å­˜çŠ¶æ€
  function setupAutoSave() {
    // æ¯5ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€
    setInterval(savePlayerState, 5000);
    
    // é¡µé¢å¸è½½æ—¶ä¿å­˜çŠ¶æ€
    window.addEventListener('beforeunload', savePlayerState);
    
    // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        savePlayerState();
      }
    });
  }
  
  // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
  function createAudioElement() {
    audioElement = new Audio();
    audioElement.addEventListener('timeupdate', updateProgress);
    audioElement.addEventListener('ended', playNext);
    audioElement.addEventListener('error', handleAudioError);
  }
  
  // å¤„ç†éŸ³é¢‘é”™è¯¯
  function handleAudioError() {
    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', audioElement.error);
    // å°è¯•ä¸‹ä¸€é¦–
    if (currentSongIndex < songs.length - 1) {
      playNext();
    }
  }
  
  // æ›´æ–°è¿›åº¦
  function updateProgress() {
    if (audioElement && audioElement.duration) {
      const progress = (audioElement.currentTime / audioElement.duration) * 100;
      progressFill.style.width = progress + '%';
      
      currentTime.textContent = formatTime(Math.floor(audioElement.currentTime));
      totalTime.textContent = formatTime(Math.floor(audioElement.duration));
    }
  }
  
  // æ’­æ”¾å½“å‰æ­Œæ›²
  function playCurrentSong() {
    if (songs.length > 0 && songs[currentSongIndex]) {
      const song = songs[currentSongIndex];
      
      if (!audioElement) {
        createAudioElement();
      }
      
      if (song.url) {
        audioElement.src = song.url;
        
        // æ¢å¤æ’­æ”¾ä½ç½®
        const savedState = localStorage.getItem(MUSIC_PLAYER_STATE_KEY);
        if (savedState && isPlaying) {
          const state = JSON.parse(savedState);
          if (state.currentTime > 0) {
            audioElement.currentTime = state.currentTime;
          }
        }
        
        audioElement.play().then(() => {
          isPlaying = true;
          updatePlayButton();
        }).catch(error => {
          console.error('æ’­æ”¾å¤±è´¥:', error);
          // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€é¦–
          if (currentSongIndex < songs.length - 1) {
            playNext();
          }
        });
      } else {
        console.error('æ­Œæ›²URLä¸ºç©º:', song);
        // å¦‚æœURLä¸ºç©ºï¼Œå°è¯•ä¸‹ä¸€é¦–
        if (currentSongIndex < songs.length - 1) {
          playNext();
        }
      }
    }
  }
  
  // æ’­æ”¾ä¸‹ä¸€é¦–
  function playNext() {
    if (songs.length > 0) {
      currentSongIndex = (currentSongIndex + 1) % songs.length;
      updateSongInfo();
      updatePlaylist();
      if (isPlaying) {
        playCurrentSong();
      }
    }
  }
  
  // æ’­æ”¾ä¸Šä¸€é¦–
  function playPrev() {
    if (songs.length > 0) {
      currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
      updateSongInfo();
      updatePlaylist();
      if (isPlaying) {
        playCurrentSong();
      }
    }
  }
  
  // æš‚åœæ’­æ”¾
  function pauseCurrentSong() {
    if (audioElement) {
      audioElement.pause();
    }
    isPlaying = false;
    updatePlayButton();
  }
  
  // æ›´æ–°æ’­æ”¾æŒ‰é’®
  function updatePlayButton() {
    const icon = playBtn.querySelector('i');
    if (isPlaying) {
      icon.className = 'fas fa-pause';
      musicToggleBtn.classList.add('playing');
    } else {
      icon.className = 'fas fa-play';
      musicToggleBtn.classList.remove('playing');
    }
  }
  
  // æ›´æ–°æ­Œæ›²ä¿¡æ¯
  function updateSongInfo() {
    if (songs.length > 0 && songs[currentSongIndex]) {
      const song = songs[currentSongIndex];
      songTitle.textContent = song.title;
      songArtist.textContent = song.artist;
    }
  }
  
  // æ›´æ–°æ’­æ”¾åˆ—è¡¨
  function updatePlaylist() {
    playlistList.innerHTML = songs.map((song, index) => `
      <div class="playlist-item ${index === currentSongIndex ? 'active' : ''}" data-index="${index}">
        <div class="song-info">
          <div class="song-name">${song.title}</div>
          <div class="song-artist">${song.artist}</div>
        </div>
      </div>
    `).join('');
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.playlist-item').forEach(item => {
      item.addEventListener('click', function() {
        currentSongIndex = parseInt(this.dataset.index);
        updateSongInfo();
        updatePlaylist();
        if (isPlaying) {
          playCurrentSong();
        }
      });
    });
  }
  
  // è·å–ç½‘æ˜“äº‘æ­Œå•æ•°æ®
  async function fetchPlaylist() {
    try {
      console.log('æ­£åœ¨è·å–æ­Œå•æ•°æ®...');
      // ä»é…ç½®æ–‡ä»¶ä¸­è·å–æ­Œå• ID
      const playlistId = '2993057618';
      console.log('ä½¿ç”¨æ­Œå• ID:', playlistId);
      
      const response = await fetch(`https://api.injahow.cn/meting/?type=playlist&id=${playlistId}`);
      const data = await response.json();
      
      console.log('æ­Œå•æ•°æ®:', data);
      
      if (data && data.length > 0) {
        songs = data.map(song => ({
          title: song.name || song.title,
          artist: song.artist || song.ar?.[0]?.name || 'æœªçŸ¥è‰ºæœ¯å®¶',
          url: song.url,
          pic: song.pic
        }));
        
        updatePlaylist();
        updateSongInfo();
        songCount.textContent = `${songs.length}é¦–`;
      }
    } catch (error) {
      console.error('è·å–æ­Œå•å¤±è´¥:', error);
      // ä½¿ç”¨å¤‡ç”¨æ•°æ®
      songs = [
        { title: "åŠ è½½å¤±è´¥", artist: "è¯·æ£€æŸ¥ç½‘ç»œ", url: "", pic: "" }
      ];
      updatePlaylist();
      updateSongInfo();
    }
  }
  
  // åˆ‡æ¢éŸ³ä¹é¢æ¿
  if (musicToggleBtn && musicPanel) {
    musicToggleBtn.addEventListener('click', function() {
      console.log('éŸ³ä¹æŒ‰é’®è¢«ç‚¹å‡»');
      musicPanel.classList.toggle('active');
      if (songs.length === 0) {
        fetchPlaylist().then(() => {
          // æ­Œå•åŠ è½½å®Œæˆåï¼Œå¦‚æœæœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œæ¢å¤æ’­æ”¾
          const stateRestored = restorePlayerState();
          if (stateRestored && songs.length > 0) {
            updateSongInfo();
            updatePlaylist();
            if (isPlaying) {
              playCurrentSong();
            }
          }
        });
      }
      savePlayerState(); // ä¿å­˜é¢æ¿çŠ¶æ€
    });
  }
  
  // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
  document.addEventListener('click', function(e) {
    if (musicPanel && !musicPanel.contains(e.target) && !musicToggleBtn.contains(e.target)) {
      musicPanel.classList.remove('active');
    }
  });
  
  // æ’­æ”¾æ§åˆ¶
  if (playBtn) {
    playBtn.addEventListener('click', function() {
      if (isPlaying) {
        pauseCurrentSong();
      } else {
        playCurrentSong();
      }
    });
  }
  
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      playPrev();
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      playNext();
    });
  }
  
  // é¡µé¢åˆå§‹åŒ–æ—¶æ¢å¤çŠ¶æ€
  document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨');
    
    // å°è¯•æ¢å¤ä¿å­˜çš„çŠ¶æ€
    const stateRestored = restorePlayerState();
    
    // å¦‚æœæœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œå…ˆåŠ è½½æ­Œå•ç„¶åæ¢å¤æ’­æ”¾
    if (stateRestored) {
      fetchPlaylist().then(() => {
        if (songs.length > 0) {
          updateSongInfo();
          updatePlaylist();
          if (isPlaying) {
            playCurrentSong();
          }
        }
      });
    }
    
    // è®¾ç½®è‡ªåŠ¨ä¿å­˜
    setupAutoSave();
  });
  
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }
</script>

<style>
  .mini-music-player {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
  }
  
  .music-toggle-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .music-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
  }
  
  .music-toggle-btn.playing {
    animation: musicPulse 2s infinite;
  }
  
  .music-panel {
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 320px;
    max-height: 450px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .music-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  
  .custom-player {
    padding: 16px;
  }
  
  .player-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .song-info {
    flex: 1;
    min-width: 0;
  }
  
  .song-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }
  
  .song-artist {
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .player-controls {
    display: flex;
    gap: 8px;
  }
  
  .control-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .control-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
  }
  
  .progress-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px 0;
  }
  
  .progress-time {
    font-size: 0.7rem;
    color: #666;
    min-width: 30px;
    text-align: center;
  }
  
  .progress-track {
    flex: 1;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5, #3730a3);
    border-radius: 2px;
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .playlist-container {
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
  }
  
  .playlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    font-size: 0.8rem;
    font-weight: 600;
    color: #333;
    border-bottom: 1px solid #e9ecef;
  }
  
  .song-count {
    color: #666;
    font-size: 0.7rem;
  }
  
  .playlist-list {
    max-height: 180px;
    overflow-y: auto;
  }
  
  .playlist-item {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .playlist-item:hover {
    background: #f8f9fa;
  }
  
  .playlist-item.active {
    background: linear-gradient(135deg, #4f46e5, #3730a3);
    color: #fff;
  }
  
  .playlist-item .song-name {
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .playlist-item .song-artist {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .playlist-item.active .song-artist {
    opacity: 0.9;
  }
  
  @keyframes musicPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @media (prefers-color-scheme: dark) {
    .music-panel {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .progress-bar {
      background: #2d2d2d;
      color: #ccc;
    }
    
    .playlist-header {
      background: #2d2d2d;
      color: #fff;
      border-bottom-color: #404040;
    }
    
    .playlist-item {
      border-bottom-color: #404040;
      color: #fff;
    }
    
    .playlist-item:hover {
      background: #3d3d3d;
    }
  }
  
  @media (max-width: 768px) {
    .mini-music-player {
      bottom: 16px;
      left: 16px;
    }
    
    .music-panel {
      width: 300px;
      max-height: 400px;
    }
    
    .music-toggle-btn {
      width: 36px;
      height: 36px;
      font-size: 0.8rem;
    }
  }
</style>


  

  <!-- ä¸»è„šæœ¬ -->
  
<script src="/js/main.js"></script>


  
    <!-- MathJax v2 é…ç½®ï¼ˆç”¨æˆ·æŒ‡å®šï¼‰ -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: {
          equationNumbers: { autoNumber: 'AMS' }
        },
        extensions: ['tex2jax.js', 'MathZoom.js'],
        jax: ['input/TeX', 'output/HTML-CSS'],
        tex2jax: {
          inlineMath: [['$','$'], ['\\(','\\)']],
          displayMath: [['$$','$$'], ['\\[','\\]']],
          processEscapes: true,
          'HTML-CSS': { fonts: ['TeX'] }
        }
      });
      MathJax.Hub.Register.MessageHook('Math Processing Error', function(message) {
        alert('Math Processing Error: ' + message[1]);
      });
      MathJax.Hub.Register.MessageHook('TeX Jax - parse error', function(message) {
        alert('Math Processing Error: ' + message[1]);
      });
    </script>
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
